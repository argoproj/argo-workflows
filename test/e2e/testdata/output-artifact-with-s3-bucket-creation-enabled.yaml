# This example demonstrates bucket-creation enabled for s3 output artifacts, when the target bucket does not exist.
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: output-artifact-with-s3-bucket-creation-enabled-
spec:
  entrypoint: main
  templates:
    - name: main
      steps:
        - - name: ensure-bucket-not-exists
            template: ensure-bucket-not-exists
        - - name: generate-artifact
            template: whalesay

    - name: ensure-bucket-not-exists
      script:
        image: amazon/aws-cli
        env:
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: my-minio-cred
                key: accesskey
          - name: AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: my-minio-cred
                key: secretkey
        command: [/bin/sh]
        source: |
          aws s3api delete-bucket --endpoint-url http://minio:9000 --bucket bucket-that-does-not-exist-2 || true

    - name: whalesay
      container:
        image: argoproj/argosay:v2
        args: [ "echo", "hello world", "/tmp/hello_world.txt" ]
      outputs:
        artifacts:
          - name: hello-art
            path: /tmp/hello_world.txt
            s3:
              bucket: bucket-that-does-not-exist-2
              key: my-outputs/hello_world.txt.tgz
              endpoint: minio:9000
              insecure: true
              createBucketIfNotPresent: {}
              accessKeySecret:
                name: my-minio-cred
                key: accesskey
              secretKeySecret:
                name: my-minio-cred
                key: secretkey
