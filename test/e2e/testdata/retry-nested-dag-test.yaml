apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: retry-nested-dag
spec:
  entrypoint: outer-dag
  templates:
    - name: outer-dag
      dag:
        tasks:
          - name: dag1-step1
            template: gen-random-int-javascript
          - name: dag1-step2
            dependencies: [dag1-step1]
            template: middle-dag
          - name: dag1-step3-tofail
            dependencies: [dag1-step2]
            template: node-to-fail
            container:
              image: alpine:latest
              command: [sh, -c]
              args: ["exit 1"]

    - name: middle-dag
      dag:
        tasks:
          - name: dag2-step1
            template: inner-dag

    - name: inner-dag
      dag:
        tasks:
          - name: dag3-step1
            template: gen-random-int-javascript
          - name: dag3-step2
            dependencies: [dag3-step1]
            template: gen-random-int-javascript
          - name: dag3-step3
            dependencies: [dag3-step2]
            template: gen-random-int-javascript

    - name: gen-random-int-javascript
      script:
        image: node:9.1-alpine
        command: [node]
        source: |
          var rand = Math.floor(Math.random() * 100);
          console.log(rand);

    - name: node-to-fail
      container:
        image: alpine:latest
        command: [sh, -c]
        args: ["exit 1"]
