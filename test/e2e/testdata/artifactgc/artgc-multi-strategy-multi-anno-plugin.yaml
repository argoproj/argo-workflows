apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: testing-on-completion-and-on-deletion-strategies-plugin-
spec:
  entrypoint: entrypoint
  artifactGC:
    strategy: OnWorkflowCompletion
  podGC:
    strategy: ""
  templates:
    - name: entrypoint
      steps:
      - - name: call-first
          template: first
      - - name: call-second
          template: second
    - name: first
      container:
        image: argoproj/argosay:v2
        command:
          - sh
          - -c
        args:
          - |
            echo "hello world" > /tmp/message
      outputs:
        artifacts:
          - name: first-on-completion-1
            path: /tmp/message
            archive:
              none: {}
            plugin:
              name: test
              configuration: |
                bucket: plugin-bucket
                endpoint: minio:9000
                insecure: true
                accessKeySecret:
                  name: my-minio-cred
                  key: accesskey
                secretKeySecret:
                  name: my-minio-cred
                  key: secretkey
              key: first-on-completion-1
            artifactGC:
              strategy: OnWorkflowCompletion
              serviceAccountName: default
              podMetadata:
                annotations:
                  annotation-key-1: annotation-value-1
                  annotation-key-2: annotation-value-2
          - name: first-on-completion-2
            path: /tmp/message
            archive:
              none: {}
            plugin:
              name: test
              configuration: |
                bucket: plugin-bucket
                endpoint: minio:9000
                insecure: true
                accessKeySecret:
                  name: my-minio-cred
                  key: accesskey
                secretKeySecret:
                  name: my-minio-cred
                  key: secretkey
              key: first-on-completion-2
          - name: first-no-deletion 
            path: /tmp/message
            archive:
              none: {}
            plugin:
              name: test
              configuration: |
                bucket: plugin-bucket
                endpoint: minio:9000
                insecure: true
                accessKeySecret:
                  name: my-minio-cred
                  key: accesskey
                secretKeySecret:
                  name: my-minio-cred
                  key: secretkey
              key: first-no-deletion
            artifactGC:
              strategy: Never

    - name: second
      archiveLocation:
        plugin:
          name: test
          configuration: |
            bucket: plugin-bucket
            endpoint: minio:9000
            insecure: true
            accessKeySecret:
              name: my-minio-cred
              key: accesskey
            secretKeySecret:
              name: my-minio-cred
              key: secretkey
          key: default-to-be-overridden
      container:
        image: argoproj/argosay:v2
        command:
          - sh
          - -c
        args:
          - |
            echo "hello world" > /tmp/message
      outputs:
        artifacts:
          - name: second-on-deletion
            path: /tmp/message
            archive:
              none: {}
            plugin:
              key: second-on-deletion
            artifactGC:
              strategy: OnWorkflowDeletion
          - name: second-on-completion
            path: /tmp/message
            archive:
              none: {}
            plugin:
              name: test
              configuration: |
                bucket: plugin-bucket
                endpoint: minio:9000
                insecure: true
                accessKeySecret:
                  name: my-minio-cred
                  key: accesskey
                secretKeySecret:
                  name: my-minio-cred
                  key: secretkey
              key: second-on-completion
            artifactGC:
              strategy: OnWorkflowCompletion
