apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config-debug
  namespace: argo
  labels:
    app: haproxy
data:
  haproxy.cfg: |
    global
        daemon
        log stdout local0 debug
        stats socket /var/run/haproxy/haproxy.sock mode 600 level admin
        stats timeout 2m

    defaults
        mode tcp
        log global
        option tcplog
        option dontlognull
        timeout connect 5s
        timeout client 30s
        timeout server 30s
        retries 3

    # Health check and stats interface
    listen stats
        bind *:8404
        mode http
        stats enable
        stats uri /stats
        stats refresh 5s

    # PostgreSQL backend pool with enhanced logging
    backend postgres_backend
        mode tcp
        balance roundrobin
        option tcp-check
        option log-health-checks
        
        # Enhanced PostgreSQL health check with proper termination
        tcp-check connect
        tcp-check send-binary 00000020000000030000757365720000706f737467726573000000
        tcp-check expect binary 52
        tcp-check send-binary 5800000008000000  # PostgreSQL termination message
        
        server postgres-primary postgres-primary.argo.svc.cluster.local:5432 check inter 5s rise 2 fall 3
        server postgres-secondary postgres-secondary.argo.svc.cluster.local:5432 check inter 5s rise 2 fall 3
        server postgres-tertiary postgres-tertiary.argo.svc.cluster.local:5432 check inter 5s rise 2 fall 3

    # Frontend listener
    frontend postgres_frontend
        bind *:5432
        mode tcp
        default_backend postgres_backend