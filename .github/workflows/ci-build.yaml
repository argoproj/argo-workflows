name: CI
on:
  push:
    branches:
      - "master"
      - "release-*"
      - "!release-2.8"
  pull_request:
    branches:
      - "master"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: "1.18"
          cache: true
      - run: make test STATIC_FILES=false GOTEST='go test -p 20 -covermode=atomic -coverprofile=coverage.out'
      # engineers just ignore this in PRs, so lets not even run it
      - run: bash <(curl -s https://codecov.io/bash)
        if: github.ref == 'refs/heads/master'

  argoexec-image:
    name: argoexec-image
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # needs: [ lint ]
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
      - name: Build and export
        uses: docker/build-push-action@v3
        with:
          context: .
          tags: quay.io/argoproj/argoexec:latest
          outputs: type=docker,dest=/tmp/argoexec_image.tar
          target: argoexec
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - uses: actions/upload-artifact@v3
        with:
          name: argoexec
          path: /tmp/argoexec_image.tar
          if-no-files-found: error

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [ argoexec-image ]
    env:
      KUBECONFIG: /home/runner/.kubeconfig
      PROFILE: minimal
      API: "false"
      INSTALL_K3S_VERSION: v1.25.2+k3s1
    strategy:
      fail-fast: false
      matrix:
        test:
          - test: test-executor
          - test: test-corefunctional
          - test: test-api
          - test: test-cli
          - test: test-plugins
          - test: test-cron
          - test: test-examples
          - test: test-java-sdk
          - test: test-python-sdk
        include:
          - test: test-executor
            k3s_version: v1.21.2+k3s1
          - test: test-functional
            k3s_version: v1.21.2+k3s1
          - test: test-corefunctional
            k3s_version: v1.21.2+k3s1
    steps:
      - name: Set-up env
        run: |
          set -eux
          case "${{matrix.test}}" in
            test-api|test-cli)
              echo PROFILE=mysql >> $GITHUB_ENV
              echo API=true >> $GITHUB_ENV
              ;;
            test-plugins)
              echo PROFILE=plugins >> $GITHUB_ENV
              ;;
            test-java-sdk|test-python-sdk)
              echo API=true >> $GITHUB_ENV
              ;;
          esac
          if [ "${{matrix.k3s_version}}" != "" ]; then
            echo=INSTALL_K3S_VERSION${{matrix.k3s_version}}  >> $GITHUB_ENV
          fi
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: "1.18"
          cache: true
      - uses: actions/setup-java@v3
        if: ${{matrix.test == 'test-java-sdk'}}
        with:
          java-version: '8'
          distribution: adopt
          cache: maven
      - uses: actions/setup-python@v4
        if: ${{matrix.test == 'test-python-sdk'}}
        with:
          python-version: '3.x'
          cache: pip
      - name: Install and start K3S
        run: |
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=$INSTALL_K3S_VERSION INSTALL_K3S_CHANNEL=stable INSTALL_K3S_EXEC=--docker K3S_KUBECONFIG_MODE=644 sh -
          until kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml cluster-info ; do sleep 10s ; done
          cp /etc/rancher/k3s/k3s.yaml /home/runner/.kubeconfig
          echo "- name: fake_token_user" >> $KUBECONFIG
          echo "  user:" >> $KUBECONFIG
          echo "    token: xxxxxx" >> $KUBECONFIG
          until kubectl cluster-info ; do sleep 10s ; done
      - uses: actions/download-artifact@v3
        name: Download argoexec image
        with:
          name: argoexec
          path: /tmp
      - run: docker load < /tmp/argoexec_image.tar
        name: Load argoexec image
      - name: Set-up /etc/hosts
        run: |
          echo '127.0.0.1 dex'      | sudo tee -a /etc/hosts
          echo '127.0.0.1 minio'    | sudo tee -a /etc/hosts
          echo '127.0.0.1 postgres' | sudo tee -a /etc/hosts
          echo '127.0.0.1 mysql'    | sudo tee -a /etc/hosts
          echo '127.0.0.1 azurite'  | sudo tee -a /etc/hosts
      - run: make install PROFILE=$PROFILE STATIC_FILES=false
        name: Install manifests
      - run: make controller $(go env GOPATH)/bin/goreman STATIC_FILES=false
        name: Build controller
      - run: make cli STATIC_FILES=false
        if: ${{env.API}}
        name: Build CLI
      - run: make start PROFILE=$PROFILE AUTH_MODE=client STATIC_FILES=false LOG_LEVEL=info API=$API UI=false LOGS=false > /tmp/argo.log 2>&1 &
        name: Start controller/API
      - run: make wait
        timeout-minutes: 4
        name: Wait for controller to be up
      - name: Run tests ${{matrix.test}}
        # https://github.com/marketplace/actions/retry-step
        uses: nick-fields/retry@v2.8.2
        with:
          timeout_minutes: 20
          max_attempts: 2
          command: make ${{matrix.test}} E2E_SUITE_TIMEOUT=20m STATIC_FILES=false
      - if: ${{ failure() }}
        name: MinIO/MySQL deployment
        run: |
          set -eux
          kubectl get deploy
          kubectl describe deploy
      - if: ${{ failure() }}
        name: MinIO/MySQL pods
        run: |
          set -eux
          kubectl get pods -l '!workflows.argoproj.io/workflow'
          kubectl describe pods -l '!workflows.argoproj.io/workflow'
      - if: ${{ failure() }}
        name: MinIO/MySQL logs
        run: kubectl logs -l '!workflows.argoproj.io/workflow' --prefix
      - if: ${{ failure() }}
        name: Controller/API logs
        run: |
          [ -e /tmp/argo.log ] && cat /tmp/argo.log
      - if: ${{ failure() }}
        name: Workflows
        run: |
          set -eux
          kubectl get wf
          kubectl describe wf
      - if: ${{ failure() }}
        name: Workflow pods
        run: |
          set -eux
          kubectl get pods -l workflows.argoproj.io/workflow
          kubectl describe pods -l workflows.argoproj.io/workflow
      - if: ${{ failure() }}
        name: Wait container logs
        run: kubectl logs -c wait -l workflows.argoproj.io/workflow --prefix
  codegen:
    name: Codegen
    runs-on: ubuntu-latest
    needs: [ tests ]
    timeout-minutes: 20
    env:
      GOPATH: /home/runner/go
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: "1.19"
          cache: true
      - name: Install protoc
        run: |
          set -eux -o pipefail
          curl -OL https://github.com/protocolbuffers/protobuf/releases/download/v3.19.4/protoc-3.19.4-linux-x86_64.zip
          sudo unzip -o protoc-3.19.4-linux-x86_64.zip -d /usr/local bin/protoc
          sudo unzip -o protoc-3.19.4-linux-x86_64.zip -d /usr/local 'include/*'
          sudo chmod +x /usr/local/bin/protoc
          sudo find /usr/local/include -type f | xargs sudo chmod a+r
          sudo find /usr/local/include -type d | xargs sudo chmod a+rx
          ls /usr/local/include/google/protobuf/
      - run: docker pull openapitools/openapi-generator-cli:v5.2.1 &
      - name: Create links
        run: |
          mkdir -p /home/runner/go/src/github.com/argoproj
          ln -s "$PWD" /home/runner/go/src/github.com/argoproj/argo-workflows
      - run: make codegen -B STATIC_FILES=false
      - run: git diff --exit-code

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [ tests, codegen ]
    timeout-minutes: 10
    env:
      GOPATH: /home/runner/go
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: "1.18"
          cache: true
      - run: make lint STATIC_FILES=false
      - run: git diff --exit-code

  ui:
    name: UI
    runs-on: ubuntu-latest
    timeout-minutes: 6
    env:
      NODE_OPTIONS: --max-old-space-size=4096
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "16"
          cache: yarn
          cache-dependency-path: ui/yarn.lock
      - run: yarn --cwd ui install
      - run: yarn --cwd ui build
      - run: yarn --cwd ui test
      - run: yarn --cwd ui lint
      - run: git diff --exit-code
      # check to see if it'll start (but not if it'll render)
      - run: yarn --cwd ui start &
      - run: until curl http://localhost:8080 > /dev/null ; do sleep 10s ; done
        timeout-minutes: 1
