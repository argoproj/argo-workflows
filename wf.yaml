apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: test-sema
spec:
  entrypoint: main
  templates:
  - name: main
    dag:
      tasks:
      - name: build-all
        template: build-all
  - name: build-all
    steps:
#    - - name: split
#        template: split
    - - name: build
        template: build
        arguments:
          parameters:
          - name: baseid
            value: "{{item}}"
        withSequence:
          count: "10"
  - name: split
    script: 
      image: python:3.9-slim
      command: ["python"]
      source: |
        import json
        import sys

        output = []
        for id in range(20):
            output.append({'baseid': id, 'tarid': id + 10000})
        json.dump(output, sys.stdout)
  - name: build
    synchronization:
      semaphore:
        configMapKeyRef:
          name: conf
          key: maxbuilder
    inputs:
      parameters:
      - name: baseid
    container:
      image: alpine:latest
      command: [sh, -c]
      args: ["sleep 10; echo acquired lock"]
