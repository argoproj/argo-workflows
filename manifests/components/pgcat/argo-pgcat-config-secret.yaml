apiVersion: v1
kind: Secret
metadata:
  name: argo-pgcat-config
  namespace: argo
  labels:
    app: pgcat
type: Opaque
stringData:
  username: postgres
  password: password
  pgcat.toml: |
    [general]
    host = "0.0.0.0"
    port = 5432
    enable_prometheus_exporter = true
    prometheus_exporter_port = 9930
    # Admin credentials for pgcat management interface
    admin_username = "postgres"
    admin_password = "postgres"
    # Enable connection pooling and health checks for failover
    connect_timeout = 1000
    idle_timeout = 30000
    server_lifetime = 86400000
    healthcheck_timeout = 1000
    healthcheck_delay = 1000

    [pools.postgres]
    pool_mode = "transaction"
    default_role = "primary"
    query_parser_enabled = true
    primary_reads_enabled = true
    # Enable automatic failover for DNS resiliency
    automatic_failover = true
    failover_timeout = 1000
    # Load balancing strategy for multiple servers
    load_balancing_mode = "random"

    [pools.postgres.users.0]
    username = "postgres"
    password = "password"
    pool_size = 25
    min_pool_size = 5
    # Connection limits for resilience
    statement_timeout = 60000
    connect_timeout = 1000

    
    # Primary shard - targets postgres-primary service
    [pools.postgres.shards.0]
    servers = [
      [ "postgres-primary.argo.svc.cluster.local", 5432, "primary" ],
      [ "postgres-secondary.argo.svc.cluster.local", 5432, "primary" ],
      [ "postgres-tertiary.argo.svc.cluster.local", 5432, "primary" ],
    ]
    database = "postgres"
    # Health check configuration for automatic failover
    connect_timeout = 5000
    query_timeout = 10000