apiVersion: v1
kind: Secret
metadata:
  name: argo-pgcat-config
  namespace: argo
  labels:
    app: pgcat
type: Opaque
stringData:
  username: postgres
  password: password
  pgcat.toml: |
    [general]
    host = "0.0.0.0"
    port = 5432
    enable_prometheus_exporter = true
    prometheus_exporter_port = 9930
    # Admin credentials for pgcat management interface
    admin_username = "postgres"
    admin_password = "postgres"
    # Enable connection pooling and health checks for failover
    connect_timeout = 5000
    idle_timeout = 30000
    server_lifetime = 86400000
    healthcheck_timeout = 1000
    healthcheck_delay = 30000

    [pools.postgres]
    pool_mode = "transaction"
    default_role = "primary"
    query_parser_enabled = true
    primary_reads_enabled = true
    # Enable automatic failover for DNS resiliency
    automatic_failover = true
    failover_timeout = 5000
    # Load balancing strategy for multiple servers
    load_balancing_mode = "random"

    [pools.postgres.users.0]
    username = "postgres"
    password = "password"
    pool_size = 25
    min_pool_size = 5
    # Connection limits for resilience
    statement_timeout = 60000
    connect_timeout = 5000

    # Configure multiple PostgreSQL endpoints for DNS resiliency
    # Use multiple shards with one primary each for DNS failover
    # This provides DNS resiliency while maintaining pgcat's requirement of one primary per shard
    [pools.postgres.shards.0]
    servers = [
      # Primary endpoint - using the actual PostgreSQL service
      [ "postgres.argo.svc.cluster.local", 5432, "primary" ],
    ]
    database = "postgres"
    # Health check configuration for automatic failover
    connect_timeout = 5000
    query_timeout = 30000

    # Secondary shard for DNS resiliency - same service via short name
    [pools.postgres.shards.1]
    servers = [
      [ "postgres", 5432, "primary" ],
    ]
    database = "postgres"
    connect_timeout = 5000
    query_timeout = 30000

    # Tertiary shard for maximum DNS resiliency - same service via FQDN
    [pools.postgres.shards.2]
    servers = [
      [ "postgres.argo.svc.cluster.local.", 5432, "primary" ],
    ]
    database = "postgres"
    # Health check configuration for automatic failover
    connect_timeout = 5000
    query_timeout = 30000
