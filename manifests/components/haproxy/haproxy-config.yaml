apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: argo
  labels:
    app: haproxy
data:
  haproxy.cfg: |
    global
        daemon
        log stdout local0 info
        stats socket /var/run/haproxy/haproxy.sock mode 600 level admin
        stats timeout 2m

    defaults
        mode tcp
        log global
        option tcplog
        option dontlognull
        timeout connect 5s
        timeout client 30s
        timeout server 30s
        retries 3

    # Health check and stats interface
    listen stats
        bind *:8404
        mode http
        stats enable
        stats uri /stats
        stats refresh 5s

    # PostgreSQL backend pool
    backend postgres_backend
        mode tcp
        balance roundrobin
        
        option httpchk GET /master
        http-check expect status 200
        
        server postgres-0 postgres-0.postgres.argo.svc.cluster.local:5432 check port 8008 inter 3s fall 3 rise 2 init-addr last,libc,none
        server postgres-1 postgres-1.postgres.argo.svc.cluster.local:5432 check port 8008 inter 3s fall 3 rise 2 init-addr last,libc,none
        server postgres-2 postgres-2.postgres.argo.svc.cluster.local:5432 check port 8008 inter 3s fall 3 rise 2 init-addr last,libc,none

    # Frontend listener
    frontend postgres_frontend
        bind *:5432
        mode tcp
        default_backend postgres_backend
