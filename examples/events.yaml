# This example demonstrates creating a workflow that waits on two CloudEvents.
# curl -X POST -d '{"context": {"id": "a", "type": "test"}}' https://localhost:2746/api/v1/events/argo -k -H 'Authorization: Bearer token:PXnB9D6CGvFYzAFa0WeOj97Ik6uLEHXq'
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: events-
spec:
  entrypoint: events
  templates:
    - name: events
      dag:
        tasks:
          - name: start
            template: whalesay
          - name: a
            template: a
            dependencies: [start]
          - name: b
            template: b
            dependencies: [a]
          - name: c
            template: c
            dependencies: [start]
          - name: run
            template: whalesay
            dependencies: [a, b, c]

    - name: a
      eventConsumer:
        expression: context.type == "test" && (context.id contains "a")

    - name: b
      eventProducer:
        http:
          insecureSkipVerify: true
          url: https://localhost:2746/api/v1/events/argo
          headers:
            - name: Authorization
              value: Bearer token:PXnB9D6CGvFYzAFa0WeOj97Ik6uLEHXq
          body:
            context:
              type: test
              id: "{{workflow.uid}}"

    - name: c
      eventConsumer:
        expression: context.type == "test" && (context.id contains "b")

    - name: whalesay
      container:
        image: docker/whalesay
