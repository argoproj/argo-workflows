---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: submit-workflow-template
rules:
  - apiGroups:
      - argoproj.io
    resources:
      - workflowtemplates
    verbs:
      - get
  - apiGroups:
      - argoproj.io
    resources:
      - workflows
    verbs:
      - create
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: public-github
automountServiceAccountToken: false
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: github
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: submit-workflow-template
subjects:
  - kind: ServiceAccount
    name: public-github
    namespace: argo
---
kind: Secret
apiVersion: v1
metadata:
  name: public-github
  annotations:
    kubernetes.io/service-account.name: public-github
type: kubernetes.io/service-account-token
---
kind: Secret
apiVersion: v1
metadata:
  name: webhooks
stringData:
  public-github: |
    type: github
    secret: "123456"
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: ci-job
spec:
  event:
    expression: metadata.claimSet.sub == "system:serviceaccount:argo:public-github" && metadata["x-github-event"] == ["push"]
    parameters:
      - expression: event.after
        name: revision
      - expression: event.repository.clone_url
        name: repo
  arguments:
    parameters:
      - name: repo
      - name: revision
  entrypoint: main
  templates:
    - name: main
      script:
        image: docker/whalesay:latest
        workingDir: /work
        command:
          - sh
        source: |
          git clone "{{workflow.parameters.repo}}" .
          git checkout "{{workflow.parameters.revision}}"
