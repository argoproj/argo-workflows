# TODO - this does not work today
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: submit-workflow-template
rules:
  - apiGroups:
      - argoproj.io
    resources:
      - workflowtemplates
    verbs:
      - get
  - apiGroups:
      - argoproj.io
    resources:
      - workflows
    verbs:
      - create
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jenkins
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: jenkins
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: submit-workflow-template
subjects:
  - kind: ServiceAccount
    name: jenkins
    namespace: argo
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: ci-job
spec:
  event:
    expression: metadata.claimSet.sub == "system:serviceaccount:argo:jenkins" 
    parameters:
      - expression: event.revision
        name: revision
      - expression: event.repo
        name: repo
  arguments:
    parameters:
      - name: repo
      - name: revision
  entrypoint: main
  templates:
    - name: main
      script:
        image: docker/whalesay:latest
        workingDir: /work
        command:
          - sh
        source: |
          git clone --depth 1 "{{workflow.parameters.repo}}" .
          git checkout "{{workflow.parameters.revision}}"
