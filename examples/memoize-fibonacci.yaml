# This example demonstrates the ability to memoize the calculation of a fibonacci sequence with a workflow
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: memoized-fibonacci-
spec:
  entrypoint: plan
  templates:
    - name: plan
      steps:
        - - name: recurse
            template: fibonacci
            arguments:
              parameters:
                - name: num
                  value: 10
    - name: fibonacci
      inputs:
        parameters:
          - name: num
      steps:
        - - name: fibonacci-executor
            template: fibonacci-step
            arguments:
              parameters:
                - name: num
                  value: "{{inputs.parameters.num}}"
        - - name: continue
            template: fibonacci
            when: "{{inputs.parameters.num}} > 2"
            arguments:
              parameters:
                - name: num
                  value: "{{steps.fibonacci-executor.outputs.parameters.result}}"
        - - name: stop
            template: base
            when: "{{inputs.parameters.num}} < 3"
            arguments:
              parameters:
                - name: num
                  value: "{{steps.fibonacci-executor.outputs.parameters.result}}"
#
    - name: fibonacci-step
      inputs:
        parameters:
          - name: num
      container:
        image: alpine:latest
        command: [sh, -c]
        args: ["echo $(({{inputs.parameters.num}}-1 + {{inputs.parameters.num}}-2)) > /tmp/result.txt"]
      outputs:
        parameters:
          - name: result
            valueFrom:
              default: 0
              path: /tmp/result.txt

    - name: base
      inputs:
        parameters:
          - name: num
      container:
        image: alpine:latest
        command: [sh, -c]
        args: ["echo {{inputs.parameters.num}} > /tmp/result.txt"]
      outputs:
        parameters:
          - name: result
            valueFrom:
              default: 0
              path: /tmp/result.txt
