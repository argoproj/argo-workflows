apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: build-argo
spec:
  ttlStrategy:
    secondsAfterCompletion: 600
  entrypoint: main
  parallelism: 1
  templates:
    - name: main
      dag:
        tasks:
          - name: checkout
            template: checkout
          - name: unit-test
            template: unit-test
            dependencies:
              - checkout
          - name: build-ui
            template: build-ui
            dependencies:
              - checkout

    - name: checkout
      script:
        image: golang:1.13.4
        command:
          - bash
        source: |
          git clone --depth 1 --branch master --single-branch https://github.com/argoproj/argo.git /root/argo
      outputs:
        artifacts:
          - name: code
            path: /root/argo
            s3:
              key: code
    - name: unit-test
      inputs:
        artifacts:
          - name: code
            path: /go/src/github.com/argoproj/argo
            s3:
              key: code
          - name: go-cache
            path: /root/.cache/go-build
            optional: true
            s3:
              key: go-cache
          - name: go-mod-cache
            path: /go/pkg/mod
            optional: true
            s3:
              key: go-mod-cache
      script:
        image: golang:1.13.4
        workingDir: /go/src/github.com/argoproj/argo
        command:
          - bash
        source: |
          set -eux o pipefail
          go env
          make server/static/files.go STATIC_FILES=false
          go build ./...
          env GOMAXPROCS=1 make test
      outputs:
        artifacts:
          - name: go-cache
            path: /root/.cache/go-build
            s3:
              key: go-cache
          - name: go-mod-cache
            path: /go/pkg/mod
            s3:
              key: go-mod-cache
          - name: test-results
            path: /go/src/github.com/argoproj/argo/test-results
            s3:
              key: test-results
    - name: build-ui
      inputs:
        artifacts:
          - name: code
            path: /go/src/github.com/argoproj/argo
            s3:
              key: code
          - name: node_modules
            path: /go/src/github.com/argoproj/argo/ui/node_modules
            optional: true
            s3:
              key: node_modules
      script:
        image: node:14.0.0
        workingDir: /go/src/github.com/argoproj/argo/ui
        command:
          - bash
        source: |
          set -eux o pipefail
          yarn install
          yarn build
      outputs:
        artifacts:
          - name: node_modules
            path: /go/src/github.com/argoproj/argo/ui/node_modules
            s3:
              key: node_modules
