# For complete documentation please see:
#
#   docs/metrics.md
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: hello-world-
spec:
  entrypoint: steps
  metrics:
    prometheus:
      - name: duration_gauge
        labels:
          - key: name
            value: workflow
        help: "Duration gauge by name"
        gauge:
          realtime: true  # This metric will be emitted in real time. For more info see: docs/metrics.md
          value: "{{workflow.duration}}"

  templates:
    - name: steps
      steps:
        - - name: random-int
            template: random-int
            metrics:
              prometheus:
                - name: random_int_step_histogram
                  help: "Value of the int emitted by random-int at step level"
                  histogram:
                    value: "{{step.outputs.parameters.rand-int-value}}"
                    buckets:
                      - 2.01
                      - 4.01
                      - 6.01
                      - 8.01
                      - 10.01
                - name: duration_gauge
                  labels:
                    - key: name
                      value: random-int
                  help: "Duration gauge by name"
                  gauge:
                    realtime: true
                    value: "{{step.duration}}"
        - - name: flakey
            template: flakey
            metrics:
              prometheus:
                - name: execution_counter
                  help: "How many times a step has executed"
                  labels:
                    - key: name
                      value: flakey
                  counter:
                    value: "1"
                - name: failure_counter
                  help: "How many times a step has failed"
                  labels:
                    - key: name
                      value: flakey
                  when: "{{step.status}} == Failed"
                  counter:
                    value: "1"

    - name: random-int
      outputs:
        parameters:
          - name: rand-int-value
            globalName: rand-int-value
            valueFrom:
              path: /tmp/rand_int.txt
      container:
        image: alpine:latest
        command: [sh, -c]
        args: ["RAND_INT=$((1 + RANDOM % 10)); echo $RAND_INT; echo $RAND_INT > /tmp/rand_int.txt"]

    - name: flakey
      container:
        image: python:alpine3.6
        command: ["python", -c]
        # fail with a 66% probability
        args: ["import random; import sys; exit_code = random.choice([0, 1, 1]); sys.exit(exit_code)"]